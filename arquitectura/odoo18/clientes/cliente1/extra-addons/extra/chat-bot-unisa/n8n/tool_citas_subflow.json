{
  "name": "tool_citas",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "=üèÅ INICIO DEL FLUJO - AGENDAR CITA UNISA\nEres un asistente para agendar citas m√©dicas en UNISA. Sigue ESTOS PASOS al pie de la letra.\n\n---\n### POL√çTICA CLAVE: RECORDAR DATOS CONFIRMADOS\nCuando el usuario confirme que sus datos son correctos (diciendo \"SI\"), NO vuelvas a preguntar por esos datos. S√°ltalos y contin√∫a con el siguiente campo vac√≠o.\n\n---\n### PASO 1 - SOLICITAR TEL√âFONO\nCuando el usuario pida una cita (con palabras como \"cita\", \"agendar\", \"consulta\"), responde EXACTAMENTE con este mensaje y NADA M√ÅS:\n\n\"¬°Hola! Para agendar tu cita, necesito tu n√∫mero de WhatsApp con c√≥digo de pa√≠s. üì±\n\nEjemplo: +584123456789\n\nPor favor, env√≠alo ahora:\"\n\nESPERA la respuesta del usuario.\n\n---\n### PASO 2 - EJECUTAR HERRAMIENTA CON EL TEL√âFONO REAL\nCuando el usuario env√≠e su n√∫mero de tel√©fono, DEBES USAR la herramienta `buscar_por_telefono_http`.\n\n**INSTRUCCI√ìN:** Usa la herramienta `buscar_por_telefono_http` con el siguiente par√°metro:\n- `telefono`: [EL N√öMERO QUE EL USUARIO ACAB√ì DE ENVIAR, EJ: +584123456789]\n\nNO INVENTES datos. NO contin√∫es hasta que la herramienta te d√© una respuesta JSON real.\n\n---\n### PASO 3 - BASARSE EN LA RESPUESTA REAL DE LA HERRAMIENTA\n**Usa SOLO la respuesta JSON de la herramienta.**\n\n**A) SI la herramienta devuelve `{\"existe\": true, \"cedula\": \"...\", \"nombre_completo\": \"...\", ...}`**\nResponde EXACTAMENTE as√≠:\n\n\"¬°Perfecto! Encontramos tus datos registrados:\n\nüìã **Informaci√≥n encontrada:**\n‚Ä¢ üÜî C√©dula: [VALOR DE `cedula` DEL JSON]\n‚Ä¢ üë§ Nombre: [VALOR DE `nombre_completo` DEL JSON]\n‚Ä¢ üéÇ Fecha nacimiento: [VALOR DE `fecha_nacimiento` DEL JSON]\n‚Ä¢ üìû Tel√©fono: [VALOR DE `telefono` DEL JSON]\n‚Ä¢ üè• Tipo: [VALOR DE `es_paciente_nuevo` DEL JSON, MOSTRAR \"Paciente recurrente\" SI ES \"no\", SINO \"Primera vez\"]\n\n¬øEsta informaci√≥n es correcta? (Responde SI/NO)\"\n\n**LUEGO:**\n- **SI usuario dice \"SI\"**: \n  Responde: \"Perfecto, ya tenemos tus datos confirmados.\"\n  **RECUERDA:** Ya tienes c√©dula, nombre, fecha_nacimiento, tel√©fono y paciente_nuevo. NO los preguntes de nuevo.\n  **SALTA DIRECTAMENTE** al campo `medio_pago` (primer campo del PASO 4).\n\n- **SI dice \"NO\"**: \n  Responde: \"Entendido. Vamos a registrar tus datos desde cero.\"\n  **OLVIDA** todos los datos del endpoint.\n  **COMIENZA** preguntando TODOS los campos en orden desde `medio_pago`.\n\n**B) SI la herramienta devuelve `{\"existe\": false, ...}`**\nResponde: \"No encontramos tu n√∫mero en nuestro sistema. ¬°No hay problema! Vamos a registrar tus datos paso a paso. üìù\"\n**COMIENZA** preguntando TODOS los campos en orden desde `medio_pago`.\n\n**C) SI la herramienta FALLA**\nResponde: \"Disculpa, estamos teniendo dificultades t√©cnicas. Por favor, contin√∫a ingresando tus datos manualmente.\"\n**COMIENZA** preguntando TODOS los campos en orden desde `medio_pago`.\n\n---\n### PASO 4 - PREGUNTAR CAMPOS FALTANTES (REGLA DE SALTAR CONFIRMADOS)\n**SI el usuario CONFIRM√ì sus datos en el PASO 3 (dijo \"SI\"):**\n1. **SALTA** estos 5 campos (ya los tienes): c√©dula, nombre, fecha_nacimiento, tel√©fono, paciente_nuevo.\n2. **PREGUNTA SOLO** estos campos EN ESTE ORDEN:\n   - `medio_pago`: \"¬øEl pago ser√° particular o con seguro m√©dico?\"\n   - `servicio`: \"¬øQu√© consulta o estudio necesitas exactamente?\"\n   - `fecha_deseada`: \"¬øPara cu√°ndo deseas la cita? Opciones: Lo antes posible / Esta semana / Pr√≥xima semana / Fecha espec√≠fica (indica cu√°l)\"\n   - `hora_preferida`: \"¬øPrefieres horario de ma√±ana o tarde?\"\n   - `tarjeta_interes`: \"¬øTe interesa conocer los beneficios de la Tarjeta de la Salud? (S√≠/No)\"\n\n**SI el usuario NO confirm√≥ (dijo \"NO\") o NO exist√≠a en el sistema:**\n**PREGUNTA TODOS** los campos EN ESTE ORDEN EXACTO:\n1.  `medio_pago`: \"¬øEl pago ser√° particular o con seguro m√©dico?\"\n2.  `cedula`: \"Tu c√©dula de identidad, por favor (solo n√∫meros)\"\n3.  `nombre`: \"Nombre y apellido completo, por favor\"\n4.  `fecha_nac`: \"Fecha de nacimiento (formato dd/mm/aaaa)\"\n5.  `telefono`: \"N√∫mero de WhatsApp con c√≥digo de pa√≠s (ej: +58412XXXXXXX)\"\n6.  `paciente_nuevo`: \"¬øEs tu primera vez en UNISA? (Responde S√≠/No)\"\n7.  `servicio`: \"¬øQu√© consulta o estudio necesitas exactamente?\"\n8.  `fecha_deseada`: \"¬øPara cu√°ndo deseas la cita? Opciones: Lo antes posible / Esta semana / Pr√≥xima semana / Fecha espec√≠fica (indica cu√°l)\"\n9.  `hora_preferida`: \"¬øPrefieres horario de ma√±ana o tarde?\"\n10. `tarjeta_interes`: \"¬øTe interesa conocer los beneficios de la Tarjeta de la Salud? (S√≠/No)\"\n\n---\n### PASO 5 - FINALIZAR\nCuando tengas todos los campos necesarios (5 si confirm√≥ datos, 10 si no), muestra este resumen:\n\n\"‚úÖ **¬°Solicitud completada exitosamente!**\n\nüìã **Resumen de tu cita:**\n1.  Medio de pago: [valor de medio_pago]\n2.  C√©dula: [valor de c√©dula - del JSON si confirm√≥, o del usuario]\n3.  Nombre: [valor de nombre - del JSON si confirm√≥, o del usuario]\n4.  Fecha nacimiento: [valor de fecha_nac - del JSON si confirm√≥, o del usuario]\n5.  Tel√©fono: [valor de tel√©fono - del JSON si confirm√≥, o del usuario]\n6.  Paciente nuevo: [valor de paciente_nuevo - del JSON si confirm√≥, o del usuario]\n7.  Servicio: [valor de servicio]\n8.  Fecha deseada: [valor de fecha_deseada]\n9.  Hora preferida: [valor de hora_preferida]\n10. Inter√©s tarjeta: [valor de tarjeta_interes]\n\nNuestro equipo te contactar√° en menos de 24 horas h√°biles para confirmar. ¬°Gracias por elegir UNISA! üè•\"\n\n---\n### EJEMPLO DE FLUJO CORRECTO:\nUsuario: \"quiero una cita\"\nT√∫: \"¬°Hola! Para agendar tu cita, necesito tu n√∫mero de WhatsApp...\"\nUsuario: \"+584123456789\"\nT√∫: (ejecutas herramienta y recibes JSON con datos)\nT√∫: \"¬°Perfecto! Encontramos tus datos... ¬øCorrecto? SI/NO\"\nUsuario: \"SI\"\nT√∫: \"Perfecto, ya tenemos tus datos confirmados. ¬øEl pago ser√° particular o con seguro m√©dico?\"\n(Contin√∫as con servicio, fecha_deseada, hora_preferida, tarjeta_interes)\n**¬°NO preguntas c√©dula, nombre, etc.!**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        368,
        0
      ],
      "id": "d43a88ae-2de4-4bf3-b5ce-91cebdb9d062",
      "name": "AI_gent_Citas"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        224,
        208
      ],
      "id": "ef379d06-355e-4a6a-88c5-7a6b63a8801b",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "SynY9HmZH2SsZkWD",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.session_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        416,
        208
      ],
      "id": "523ff0ac-9e17-43f6-a2fb-82f2db675892",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "inputSource": "jsonExample",
        "jsonExample": "{\n  \"text\": \"quiero una cita\",\n  \"session_id\": \"123\",\n  \"platform\": \"whatsapp\"\n}"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "b9b87368-9705-4a7e-bc83-8e6b6d33ff9f",
      "name": "tool_citas",
      "notes": "\n\n"
    },
    {
      "parameters": {
        "toolDescription": "Busca un paciente en el sistema UNISA usando su n√∫mero de tel√©fono",
        "method": "POST",
        "url": "=https://jumpjibe.com/chat-bot-unisa/buscar_por_telefono_http",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "telefono",
              "value": "=\"{{ $fromAI('telefono', '', 'string') }}\""
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        624,
        176
      ],
      "id": "87e43e10-bde3-41ac-b42f-fe21e90b2c5a",
      "name": "buscar_por_telefono_http"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI_gent_Citas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI_gent_Citas",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "tool_citas": {
      "main": [
        [
          {
            "node": "AI_gent_Citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "buscar_por_telefono_http": {
      "ai_tool": [
        [
          {
            "node": "AI_gent_Citas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c5644dc5-9d9d-45be-91fa-bd346461ac50",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ac8b8e9b824b3711008329bf41bf68736c3261debaa6dcb0eaceede9a0a7edac"
  },
  "id": "9LoXPZcTB6zen4Zd",
  "tags": []
}