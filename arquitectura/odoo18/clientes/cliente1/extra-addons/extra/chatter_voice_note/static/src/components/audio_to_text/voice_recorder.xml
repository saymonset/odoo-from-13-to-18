<templates id="template" xml:space="preserve">
   <t t-name="chatter_voice_note.VoiceRecorder" owl="1">
    <div class="o_container p-4">

        <!-- PANEL DE DIAGN√ìSTICO BUS -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fa fa-search me-2"></i>
                    Diagn√≥stico Completo del BUS
                </h5>
            </div>
            <div class="card-body">
                <!-- ESTADO GENERAL -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Estado Conexi√≥n:</strong>
                        <!-- ‚úÖ USAR M√âTODOS SEGUROS -->
                        <span class="badge ms-2" 
                              t-att-class="getSafeConnectionClass()"
                              t-esc="getSafeWebSocketState()"/>
                    </div>
                    <div class="col-md-3">
                        <strong>Eventos Recibidos:</strong>
                        <span class="badge bg-info ms-2" t-esc="state.bus_events_received"/>
                    </div>
                    <div class="col-md-3">
                        <strong>WebSocket:</strong>
                        <!-- ‚úÖ USAR M√âTODO SEGURO -->
                        <span t-if="getSafeWebSocketStatus()" class="badge bg-success ms-2">‚úÖ</span>
                        <span t-else="" class="badge bg-danger ms-2">‚ùå</span>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-sm btn-outline-info" t-on-click="showCurrentState">
                            üîç Estado Actual
                        </button>
                    </div>
                </div>

                <!-- DETALLES DIAGN√ìSTICO -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-secondary">
                            <strong>Detalles BUS:</strong><br/>
                            <small>
                                <!-- ‚úÖ VERIFICACIONES SEGURAS EN TEMPLATE -->
                                URL: <span t-esc="state.bus_diagnostic ? (state.bus_diagnostic.url || 'No disponible') : 'No disponible'"/><br/>
                                Canales: <span t-esc="state.bus_diagnostic ? ((state.bus_diagnostic.channels || []).length) : 0"/><br/>
                                √öltimo evento: 
                                <t t-if="state.bus_diagnostic &amp;&amp; state.bus_diagnostic.lastEvent">
                                    <span t-esc="state.bus_diagnostic.lastEvent.source"/> - 
                                    <span t-esc="state.bus_diagnostic.lastEvent.type"/>
                                </t>
                                <t t-else="">Ninguno</t>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- DEBUG -->
                <div class="alert" t-att-class="state.bus_events_received &gt; 0 ? 'alert-success' : 'alert-warning'">
                    <strong>Diagn√≥stico:</strong> <span t-esc="state.debug_info"/>
                </div>
            </div>
        </div>

        <!-- BOT√ìN DIAGN√ìSTICO -->
        <div class="text-center mb-4">
            <button class="btn btn-warning btn-lg" 
                    t-on-click="testBusDiagnostic" 
                    t-att-disabled="state.loading_response"
                    style="min-width: 350px;">
                <t t-if="state.loading_response">
                    <i class="fa fa-spinner fa-spin"></i> 
                    Diagn√≥stico... (<t t-esc="state.bus_events_received"/> eventos)
                </t>
                <t t-else="">
                    üîß Ejecutar Diagn√≥stico BUS
                </t>
            </button>
        </div>

        <!-- RESULTADOS -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" t-att-class="state.final_message ? 'bg-success text-white' : 'bg-secondary text-white'">
                        <h6 class="card-title mb-0">
                            <i class="fa fa-message me-2"></i>
                            Mensaje Final
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" t-esc="state.final_message || 'Esperando mensaje de diagn√≥stico...'"/>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" t-att-class="state.answer_ia ? 'bg-success text-white' : 'bg-secondary text-white'">
                        <h6 class="card-title mb-0">
                            <i class="fa fa-robot me-2"></i>
                            Respuesta IA
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text" t-esc="state.answer_ia || 'Esperando respuesta de diagn√≥stico...'"/>
                    </div>
                </div>
            </div>
        </div>

        <!-- EVENTOS RECIBIDOS (DEBUG) -->
        <t t-if="state.all_events &amp;&amp; state.all_events.length &gt; 0">
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="card-title mb-0">
                        <i class="fa fa-list me-2"></i>
                        Eventos Recibidos (<t t-esc="state.all_events.length"/>)
                    </h6>
                </div>
                <div class="card-body">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <t t-foreach="state.all_events" t-as="event" t-key="event_index">
                            <div class="mb-2 p-2 border rounded">
                                <small>
                                    <strong t-esc="event.source || 'Desconocido'"/> - 
                                    <span t-esc="event.type || 'Sin tipo'"/> - 
                                    <span t-esc="event.timestamp || 'Sin timestamp'"/>
                                </small>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </t>

    </div>
</t>
</templates>