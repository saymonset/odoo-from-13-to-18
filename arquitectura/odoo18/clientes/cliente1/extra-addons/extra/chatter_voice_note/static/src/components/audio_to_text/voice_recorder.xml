<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
<t t-name="chatter_voice_note.VoiceRecorder" owl="1">
 
    <div class="o_container p-4">
      <!-- SecciÃ³n de Estado del Sistema -->
            <div class="alert alert-info mt-3">
                <strong>ESTADO DEL SISTEMA:</strong>
                <div>Info: <t t-esc="state.debugInfo"/></div>
                <div>MÃ©todo: <t t-esc="state.responseMethod"/></div>
                <div>Render Count: <t t-esc="state._updateCount"/></div>
            </div>

            <!-- Botones de Control -->
           <div class="alert alert-warning mt-3">
                <strong>ðŸ§ª CONTROL DEL BUS:</strong>
                <button class="btn btn-warning btn-sm" t-on-click="connectBusManually">
                    ðŸ”Œ Conectar Bus Manualmente
                </button>
                <button class="btn btn-info btn-sm ml-2" t-on-click="testBusReception">
                    ðŸ§ª Test RecepciÃ³n
                </button>
                <small class="d-block mt-1">Estado: <t t-esc="state.debugInfo"/></small>
            </div>
        <!-- GrabaciÃ³n inicial -->
        <t t-if="audioNoteManager.state.notes.length === 0">
            <h2>Voice Recorder</h2>
            <button t-on-click="toggleRecording"
                    class="btn btn-lg" 
                    t-att-class="state.recording ? 'btn-warning' : 'btn-primary'">
                <t t-esc="state.recording ? 'Stop Recording' : 'Start Recording'"/>
            </button>
        </t>

        <!-- Cuando hay notas -->
        <t t-if="audioNoteManager.state.notes.length > 0">
            <!-- Notas -->
            <div class="mt-3">
                <h4>Notas grabadas: <t t-esc="audioNoteManager.state.notes.length"/></h4>
                <t t-foreach="sortedNotes" t-as="note" t-key="note.id || note.tempId">
                    <div class="mb-2 p-2 border">
                        <strong t-esc="note.name"/>
                        <!-- CORRECCIÃ“N: controls debe tener valor en XML -->
                        <audio t-att-src="note.url" controls="controls" class="d-block mt-1 w-100"></audio>
                        <button t-on-click="() => deleteNote(note.id)" class="btn btn-sm btn-danger mt-1">
                            Eliminar
                        </button>
                    </div>
                </t>
            </div>

            <!-- Contactos -->
            <div class="mt-3">
                <h4>Contactos seleccionados: <t t-esc="contactManager.state.selectedContacts.length"/></h4>
                <input t-model="contactManager.state.searchTerm" 
                       t-on-input="() => contactManager.searchContacts()"
                       class="form-control" placeholder="Buscar contactos..."/>
                
                <t t-if="contactManager.state.availableContacts.length > 0" class="mt-2">
                    <div class="list-group">
                        <t t-foreach="contactManager.state.availableContacts" t-as="contact" t-key="contact.id">
                            <div t-on-click="() => contactManager.addContact(contact)" 
                                 class="list-group-item" style="cursor: pointer;">
                                <t t-esc="contact.name"/>
                            </div>
                        </t>
                    </div>
                </t>

                <t t-if="contactManager.state.selectedContacts.length > 0" class="mt-2">
                    <div class="list-group">
                        <t t-foreach="contactManager.state.selectedContacts" t-as="contact" t-key="contact.id">
                            <div class="list-group-item d-flex justify-content-between">
                                <span t-esc="contact.name"/>
                                <button t-on-click="() => contactManager.removeContact(contact.id)" 
                                        class="btn btn-sm btn-danger">
                                    X
                                </button>
                            </div>
                        </t>
                    </div>
                </t>
            </div>

            <!-- BotÃ³n enviar -->
            <div t-if="contactManager.state.selectedContacts.length > 0" class="mt-3">
                <button t-on-click="sendToN8N"
                        t-att-disabled="state.isSending"
                        t-att-class="state.isSending ? 'btn-secondary' : 'btn-success'"
                        class="btn btn-lg">
                    <t t-esc="state.isSending ? 'Enviando...' : 'Enviar'"/>
                </button>
            </div>
        </t>

        <!-- Respuestas -->
        <div class="row mt-4">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Mensaje Final 
                        <t t-if="state.final_message">âœ…</t>
                    </div>
                    <div class="card-body">
                        <t t-if="state.final_message">
                            <t t-esc="state.final_message"/>
                        </t>
                        <t t-else="">
                            <span class="text-muted">Esperando mensaje...</span>
                        </t>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        Respuesta IA
                        <t t-if="state.answer_ia">âœ…</t>
                    </div>
                    <div class="card-body">
                        <t t-if="state.answer_ia">
                            <t t-esc="state.answer_ia"/>
                        </t>
                        <t t-else="">
                            <span class="text-muted">Esperando respuesta IA...</span>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </div>
</t>
</templates>